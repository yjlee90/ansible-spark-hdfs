---
- name: include vars
  include_vars: "{{ playbook_dir }}/config.yml"

# SSH setting
- name: ssh-keyscan for known_hosts file
  command: /usr/bin/ssh-keyscan -t ecdsa {{ ansible_host }}
  register: keyscan
- name: input key
  lineinfile:
    path: ~/.ssh/known_hosts
    line: "{{ item }}"
    create: yes
  with_items:
    - "{{ keyscan.stdout_lines }}"

- name: ssh-keygen for authorized_keys file
  command: "ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ''"
  ignore_errors: yes

- name: Set authorized key taken from file
  authorized_key:
    user: root
    state: present
    key: "{{ lookup('file', '/root/.ssh/id_rsa.pub') }}"
  delegate_to: "{{ item[0] }}"
  with_items:
    - "{{ groups['nodes'] }}"

 